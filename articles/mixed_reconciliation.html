<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Reconciliation of M5 hierarchy with mixed-type forecasts • bayesRecon</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Reconciliation of M5 hierarchy with mixed-type forecasts">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bayesRecon</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/bayesRecon.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/mixed_reconciliation.html">Reconciliation of M5 hierarchy with mixed-type forecasts</a></li>
    <li><a class="dropdown-item" href="../articles/reconciliation_properties.html">Properties of the reconciled distribution via conditioning</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/IDSIA/bayesRecon/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Reconciliation of M5 hierarchy with mixed-type forecasts</h1>
                        <h4 data-toc-skip class="author">Dario
Azzimonti, Lorenzo Zambon, Nicolò Rubattu, Giorgio Corani</h4>
            
            <h4 data-toc-skip class="date">2024-05-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/IDSIA/bayesRecon/blob/main/vignettes/mixed_reconciliation.Rmd" class="external-link"><code>vignettes/mixed_reconciliation.Rmd</code></a></small>
      <div class="d-none name"><code>mixed_reconciliation.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/IDSIA/bayesRecon" class="external-link">bayesRecon</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette partially reproduces the results of <em>Probabilistic
reconciliation of mixed-type hierarchical time series</em> <span class="citation">(Zambon et al. 2024)</span>, published at UAI 2024 (the
40th Conference on Uncertainty in Artificial Intelligence).</p>
<p>In particular, we replicate the reconciliation of the one-step ahead
(h=1) forecasts of one store of the M5 competition <span class="citation">(Makridakis, Spiliotis, and Assimakopoulos
2022)</span>. Sect. 5 of the paper presents the results for 10 stores,
each reconciled 14 times using rolling one-step ahead forecasts.</p>
</div>
<div class="section level2">
<h2 id="data-and-base-forecasts">Data and base forecasts<a class="anchor" aria-label="anchor" href="#data-and-base-forecasts"></a>
</h2>
<p>The M5 competition <span class="citation">(Makridakis, Spiliotis, and
Assimakopoulos 2022)</span> is about daily time series of sales data
referring to 10 different stores. Each store has the same hierarchy:
3049 bottom time series (single items) and 11 upper time series,
obtained by aggregating the items by department, product category, and
store; see the figure below.</p>
<div class="figure">
<img src="img/M5store_hier.png" alt="**Figure 1**: graph of the M5 hierarchy." width="100%"><p class="caption">
<strong>Figure 1</strong>: graph of the M5 hierarchy.
</p>
</div>
<p>We reproduce the results of the store “CA_1”. The base forecasts (for
h=1) of the bottom and upper time series are stored in
<code>M5_CA1_basefc</code>, available as data in the package. The base
forecast are computed using ADAM <span class="citation">(Svetunkov and
Boylan 2023)</span>, implemented in the R package smooth <span class="citation">(Svetunkov 2023)</span>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Hierarchy composed by 3060 time series: 3049 bottom and 11 upper</span></span>
<span><span class="va">n_b</span> <span class="op">&lt;-</span> <span class="fl">3049</span></span>
<span><span class="va">n_u</span> <span class="op">&lt;-</span> <span class="fl">11</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="va">n_b</span> <span class="op">+</span> <span class="va">n_u</span>   </span>
<span></span>
<span><span class="co"># Load matrix A </span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="va">M5_CA1_basefc</span><span class="op">$</span><span class="va">A</span></span>
<span></span>
<span><span class="co"># Load base forecasts:</span></span>
<span><span class="va">base_fc_upper</span>  <span class="op">&lt;-</span> <span class="va">M5_CA1_basefc</span><span class="op">$</span><span class="va">upper</span></span>
<span><span class="va">base_fc_bottom</span> <span class="op">&lt;-</span> <span class="va">M5_CA1_basefc</span><span class="op">$</span><span class="va">bottom</span></span>
<span></span>
<span><span class="co"># We will save all the results in the list rec_fc</span></span>
<span><span class="va">rec_fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            Gauss      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            Mixed_cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            TD_cond    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="gaussian-reconciliation">Gaussian reconciliation<a class="anchor" aria-label="anchor" href="#gaussian-reconciliation"></a>
</h2>
<p>We first perform Gaussian reconciliation (<code>Gauss</code>, <span class="citation">Corani et al. (2021)</span>). It assumes all forecasts
to be Gaussian, even though the bottom base forecasts are not
Gaussian.</p>
<p>We assume the upper base forecasts to be a multivariate Gaussian and
we estimate their covariance matrix from the in-sample residuals. We
assume also the bottom base forecasts to be independent Gaussians.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parameters of the upper base forecast distributions</span></span>
<span><span class="va">mu_u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_fc_upper</span>, <span class="st">"[["</span>, <span class="st">"mu"</span><span class="op">)</span><span class="op">)</span>  <span class="co"># upper means</span></span>
<span><span class="co"># Compute the (shrinked) covariance matrix of the residuals</span></span>
<span><span class="va">residuals.upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_fc_upper</span>, <span class="st">"[["</span>, <span class="st">"residuals"</span><span class="op">)</span></span>
<span><span class="va">residuals.upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">residuals.upper</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Sigma_u</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/schaferStrimmer_cov.html">schaferStrimmer_cov</a></span><span class="op">(</span><span class="va">residuals.upper</span><span class="op">)</span><span class="op">$</span><span class="va">shrink_cov</span></span>
<span>  </span>
<span><span class="co"># Parameters of the bottom base forecast distributions</span></span>
<span><span class="va">mu_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sd_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">fc_b</span> <span class="kw">in</span> <span class="va">base_fc_bottom</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pmf</span> <span class="op">&lt;-</span> <span class="va">fc_b</span><span class="op">$</span><span class="va">pmf</span></span>
<span>  <span class="va">mu_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mu_b</span>, <span class="fu"><a href="../reference/PMF.get_mean.html">PMF.get_mean</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sd_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sd_b</span>, <span class="fu"><a href="../reference/PMF.get_var.html">PMF.get_var</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span><span class="op">**</span><span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">Sigma_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sd_b</span><span class="op">**</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mean and covariance matrix of the base forecasts</span></span>
<span><span class="va">base_forecasts.mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mu_u</span>,<span class="va">mu_b</span><span class="op">)</span></span>
<span><span class="va">base_forecasts.Sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">base_forecasts.Sigma</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_u</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n_u</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Sigma_u</span></span>
<span><span class="va">base_forecasts.Sigma</span><span class="op">[</span><span class="op">(</span><span class="va">n_u</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span>,<span class="op">(</span><span class="va">n_u</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Sigma_b</span></span></code></pre></div>
<p>We reconcile using the function <code><a href="../reference/reconc_gaussian.html">reconc_gaussian()</a></code>, which
takes as input:</p>
<ul>
<li>the summing matrix <code>A</code>;</li>
<li>the means of the base forecast, <code>base_forecasts.mu</code>;</li>
<li>the covariance of the base forecast,
<code>base_forecasts.Sigma</code>.</li>
</ul>
<p>The function returns the reconciled mean and covariance for the
bottom time series.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gaussian reconciliation </span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>       </span>
<span><span class="va">gauss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reconc_gaussian.html">reconc_gaussian</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">base_forecasts.mu</span>, <span class="va">base_forecasts.Sigma</span><span class="op">)</span></span>
<span><span class="va">stop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rec_fc</span><span class="op">$</span><span class="va">Gauss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mu_b    <span class="op">=</span> <span class="va">gauss</span><span class="op">$</span><span class="va">bottom_reconciled_mean</span>,</span>
<span>                     Sigma_b <span class="op">=</span> <span class="va">gauss</span><span class="op">$</span><span class="va">bottom_reconciled_covariance</span>,</span>
<span>                     mu_u    <span class="op">=</span> <span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gauss</span><span class="op">$</span><span class="va">bottom_reconciled_mean</span>,</span>
<span>                     Sigma_u <span class="op">=</span> <span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gauss</span><span class="op">$</span><span class="va">bottom_reconciled_covariance</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Gauss_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">stop</span>, <span class="va">start</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Time taken by Gaussian reconciliation: "</span>, <span class="va">Gauss_time</span>, <span class="st">"s"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Time taken by Gaussian reconciliation:  0.31 s</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="reconciliation-with-mixed-conditioning">Reconciliation with mixed-conditioning<a class="anchor" aria-label="anchor" href="#reconciliation-with-mixed-conditioning"></a>
</h2>
<p>We now reconcile the forecasts using the mixed-conditioning approach
of <span class="citation">Zambon et al. (2024)</span>, Sect. 3. The
algorithm is implemented in the function <code><a href="../reference/reconc_MixCond.html">reconc_MixCond()</a></code>.
The function takes as input:</p>
<ul>
<li>the aggregation matrix <code>A</code>;</li>
<li>the probability mass functions of the bottom base forecasts, stored
in the list <code>fc_bottom_4rec</code>;</li>
<li>the parameters of the multivariate Gaussian distribution for the
upper variables, <code>fc_upper_4rec</code>;</li>
<li>additional function parameters; among those note that
<code>num_samples</code> specifies the number of samples used in the
internal importance sampling (IS) algorithm.</li>
</ul>
<p>The function returns the reconciled forecasts in the form of
probability mass functions for both the upper and bottom time series.
The function parameter <code>return_type</code> can be changed to
<code>samples</code> or <code>all</code> to obtain the IS samples.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seed</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">N_samples_IS</span> <span class="op">&lt;-</span> <span class="fl">5e4</span></span>
<span></span>
<span><span class="co"># Base forecasts</span></span>
<span><span class="va">fc_upper_4rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mu<span class="op">=</span><span class="va">mu_u</span>, Sigma<span class="op">=</span><span class="va">Sigma_u</span><span class="op">)</span></span>
<span><span class="va">fc_bottom_4rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_fc_bottom</span>, <span class="st">"[["</span>, <span class="st">"pmf"</span><span class="op">)</span>  <span class="co"># list of PMFs</span></span>
<span></span>
<span><span class="co"># MixCond reconciliation</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>       </span>
<span><span class="va">mix_cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reconc_MixCond.html">reconc_MixCond</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">fc_bottom_4rec</span>, <span class="va">fc_upper_4rec</span>, bottom_in_type <span class="op">=</span> <span class="st">"pmf"</span>,</span>
<span>                          num_samples <span class="op">=</span> <span class="va">N_samples_IS</span>, return_type <span class="op">=</span> <span class="st">"pmf"</span>, seed <span class="op">=</span> <span class="va">seed</span><span class="op">)</span></span>
<span><span class="va">stop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>       </span>
<span></span>
<span><span class="va">rec_fc</span><span class="op">$</span><span class="va">Mixed_cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  bottom <span class="op">=</span> <span class="va">mix_cond</span><span class="op">$</span><span class="va">bottom_reconciled</span><span class="op">$</span><span class="va">pmf</span>,</span>
<span>  upper  <span class="op">=</span> <span class="va">mix_cond</span><span class="op">$</span><span class="va">upper_reconciled</span><span class="op">$</span><span class="va">pmf</span>,</span>
<span>  ESS    <span class="op">=</span> <span class="va">mix_cond</span><span class="op">$</span><span class="va">ESS</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">MixCond_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">stop</span>, <span class="va">start</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Computational time for Mix-cond reconciliation: "</span>, <span class="va">MixCond_time</span>, <span class="st">"s"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computational time for Mix-cond reconciliation:  9.64 s</span></span></code></pre></div>
<p>As discussed in <span class="citation">Zambon et al. (2024)</span>,
Sect. 3, conditioning with mixed variables performs poorly in high
dimensions. This is because the bottom-up distribution, built by
assuming the bottom forecasts to be independent, is untenable in high
dimensions. Moreover, forecasts for count time series are usually biased
and their sum tends to be strongly biased; see <span class="citation">Zambon et al. (2024)</span>, Fig. 3, for a graphical
example.</p>
</div>
<div class="section level2">
<h2 id="top-down-conditioning">Top down conditioning<a class="anchor" aria-label="anchor" href="#top-down-conditioning"></a>
</h2>
<p>Top down conditioning (TD-cond; see <span class="citation">Zambon et
al. (2024)</span>, Sect. 4) is a more reliable approach for reconciling
mixed variables in high dimensions. The algorithm is implemented in the
function <code><a href="../reference/reconc_TDcond.html">reconc_TDcond()</a></code>; it takes the same arguments as
<code><a href="../reference/reconc_MixCond.html">reconc_MixCond()</a></code> and returns reconciled forecasts in the
same format.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N_samples_TD</span> <span class="op">&lt;-</span> <span class="fl">1e4</span></span>
<span></span>
<span><span class="co"># TDcond reconciliation</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>     </span>
<span><span class="va">td</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reconc_TDcond.html">reconc_TDcond</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">fc_bottom_4rec</span>, <span class="va">fc_upper_4rec</span>,</span>
<span>                   bottom_in_type <span class="op">=</span> <span class="st">"pmf"</span>, num_samples <span class="op">=</span> <span class="va">N_samples_TD</span>, </span>
<span>                   return_type <span class="op">=</span> <span class="st">"pmf"</span>, seed <span class="op">=</span> <span class="va">seed</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in reconc_TDcond(A, fc_bottom_4rec, fc_upper_4rec, bottom_in_type =</span></span>
<span><span class="co">#&gt; "pmf", : Only 99.4% of the upper samples are in the support of the bottom-up</span></span>
<span><span class="co">#&gt; distribution; the others are discarded.</span></span>
<span><span class="va">stop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>  </span></code></pre></div>
<p>The algorithm TD-cond raises a warning regarding the incoherence
between the joint bottom-up and the upper base forecasts. We will see
that this warning does not impact the performances of TD-cond.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_fc</span><span class="op">$</span><span class="va">TD_cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  bottom <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">bottom_reconciled</span><span class="op">$</span><span class="va">pmf</span>,</span>
<span>  upper  <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">upper_reconciled</span><span class="op">$</span><span class="va">pmf</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">TDCond_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">stop</span>, <span class="va">start</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Computational time for TD-cond reconciliation: "</span>, <span class="va">TDCond_time</span>, <span class="st">"s"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computational time for TD-cond reconciliation:  10.27 s</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="comparison">Comparison<a class="anchor" aria-label="anchor" href="#comparison"></a>
</h2>
<p>The computational time required for the Gaussian reconciliation is
0.31 seconds, Mix-cond requires 9.64 seconds and TD-cond requires 10.27
seconds.</p>
<p>For each time series in the hierarchy, we compute the following
scores for each method:</p>
<ul>
<li><p>MASE: Mean Absolute Scaled Error</p></li>
<li><p>MIS: Mean Interval Score</p></li>
<li><p>RPS: Ranked Probability Score</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parameters for computing the scores</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>   <span class="co"># MIS uses 90% coverage intervals</span></span>
<span><span class="va">jitt</span> <span class="op">&lt;-</span> <span class="fl">1e-9</span>   <span class="co"># jitter for numerical stability </span></span>
<span></span>
<span><span class="co"># Save actual values</span></span>
<span><span class="va">actuals_u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_fc_upper</span>, <span class="st">"[["</span>, <span class="st">"actual"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">actuals_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_fc_bottom</span>, <span class="st">"[["</span>, <span class="st">"actual"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">actuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">actuals_u</span>, <span class="va">actuals_b</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Scaling factor for computing MASE</span></span>
<span><span class="va">Q_u</span> <span class="op">&lt;-</span> <span class="va">M5_CA1_basefc</span><span class="op">$</span><span class="va">Q_u</span></span>
<span><span class="va">Q_b</span> <span class="op">&lt;-</span> <span class="va">M5_CA1_basefc</span><span class="op">$</span><span class="va">Q_b</span></span>
<span><span class="va">Q</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Q_u</span>, <span class="va">Q_b</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initialize lists to save the results</span></span>
<span><span class="va">mase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mis</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rps</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The following functions are used for computing the scores:</p>
<ul>
<li>
<code>AE_pmf</code>: compute the absolute error for a PMF;</li>
<li>
<code>MIS_pmf</code>: compute interval score for a PMF;</li>
<li>
<code>RPS_pmf</code>: compute RPS for a PMF;</li>
<li>
<code>MIS_gauss</code>: compute MIS for a Gaussian
distribution.</li>
</ul>
<p>The implementation of these functions is available in the source code
of the vignette but not shown here.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute scores for the base forecasts</span></span>
<span><span class="co"># Upper</span></span>
<span><span class="va">mu_u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_fc_upper</span>, <span class="st">"[["</span>, <span class="st">"mu"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sd_u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_fc_upper</span>, <span class="st">"[["</span>, <span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mase</span><span class="op">$</span><span class="va">base</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_u</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">mu_u</span> <span class="op">-</span> <span class="va">actuals_u</span><span class="op">)</span> <span class="op">/</span> <span class="va">Q_u</span></span>
<span><span class="va">mis</span><span class="op">$</span><span class="va">base</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_u</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="fu">MIS_gauss</span><span class="op">(</span><span class="va">mu_u</span>, <span class="va">sd_u</span>, <span class="va">actuals_u</span>, <span class="va">alpha</span><span class="op">)</span></span>
<span><span class="va">rps</span><span class="op">$</span><span class="va">base</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_u</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="fu">scoringRules</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scoringRules/man/scores.html" class="external-link">crps</a></span><span class="op">(</span><span class="va">actuals_u</span>, <span class="st">"norm"</span>, mean<span class="op">=</span><span class="va">mu_u</span>, sd<span class="op">=</span><span class="va">sd_u</span><span class="op">)</span></span>
<span><span class="co"># Bottom</span></span>
<span><span class="va">pmfs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_fc_bottom</span>, <span class="st">"[["</span>, <span class="st">"pmf"</span><span class="op">)</span></span>
<span><span class="va">mase</span><span class="op">$</span><span class="va">base</span><span class="op">[</span><span class="op">(</span><span class="va">n_u</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">AE_pmf</span>, <span class="va">pmfs</span>, <span class="va">actuals_b</span><span class="op">)</span> <span class="op">/</span> <span class="va">Q_b</span></span>
<span><span class="va">mis</span><span class="op">$</span><span class="va">base</span><span class="op">[</span><span class="op">(</span><span class="va">n_u</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">MIS_pmf</span>, <span class="va">pmfs</span>, <span class="va">actuals_b</span>, MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="va">alpha</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rps</span><span class="op">$</span><span class="va">base</span><span class="op">[</span><span class="op">(</span><span class="va">n_u</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">RPS_pmf</span>, <span class="va">pmfs</span>, <span class="va">actuals_b</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute scores for Gauss reconciliation</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rec_fc</span><span class="op">$</span><span class="va">Gauss</span><span class="op">$</span><span class="va">mu_u</span>, <span class="va">rec_fc</span><span class="op">$</span><span class="va">Gauss</span><span class="op">$</span><span class="va">mu_b</span><span class="op">)</span></span>
<span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">rec_fc</span><span class="op">$</span><span class="va">Gauss</span><span class="op">$</span><span class="va">Sigma_u</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">rec_fc</span><span class="op">$</span><span class="va">Gauss</span><span class="op">$</span><span class="va">Sigma_b</span><span class="op">)</span><span class="op">)</span><span class="op">**</span><span class="fl">0.5</span></span>
<span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="va">sd</span> <span class="op">+</span> <span class="va">jitt</span></span>
<span><span class="va">mase</span><span class="op">$</span><span class="va">Gauss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">mu</span> <span class="op">-</span> <span class="va">actuals</span><span class="op">)</span> <span class="op">/</span> <span class="va">Q</span></span>
<span><span class="va">mis</span><span class="op">$</span><span class="va">Gauss</span> <span class="op">&lt;-</span> <span class="fu">MIS_gauss</span><span class="op">(</span><span class="va">mu</span>, <span class="va">sd</span>, <span class="va">actuals</span>, <span class="va">alpha</span><span class="op">)</span></span>
<span><span class="va">rps</span><span class="op">$</span><span class="va">Gauss</span> <span class="op">&lt;-</span> <span class="fu">scoringRules</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scoringRules/man/scores.html" class="external-link">crps</a></span><span class="op">(</span><span class="va">actuals</span>, <span class="st">"norm"</span>, mean<span class="op">=</span><span class="va">mu</span>, sd<span class="op">=</span><span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute scores for Mix-cond reconciliation</span></span>
<span><span class="va">pmfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rec_fc</span><span class="op">$</span><span class="va">Mixed_cond</span><span class="op">$</span><span class="va">upper</span>, <span class="va">rec_fc</span><span class="op">$</span><span class="va">Mixed_cond</span><span class="op">$</span><span class="va">bottom</span><span class="op">)</span></span>
<span><span class="va">mase</span><span class="op">$</span><span class="va">MixCond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">AE_pmf</span>, <span class="va">pmfs</span>, <span class="va">actuals</span><span class="op">)</span> <span class="op">/</span> <span class="va">Q</span></span>
<span><span class="va">mis</span><span class="op">$</span><span class="va">MixCond</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">MIS_pmf</span>, <span class="va">pmfs</span>, <span class="va">actuals</span>, MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="va">alpha</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rps</span><span class="op">$</span><span class="va">MixCond</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">RPS_pmf</span>, <span class="va">pmfs</span>, <span class="va">actuals</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute scores for TD-cond reconciliation</span></span>
<span><span class="va">pmfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rec_fc</span><span class="op">$</span><span class="va">TD_cond</span><span class="op">$</span><span class="va">upper</span>, <span class="va">rec_fc</span><span class="op">$</span><span class="va">TD_cond</span><span class="op">$</span><span class="va">bottom</span><span class="op">)</span></span>
<span><span class="va">mase</span><span class="op">$</span><span class="va">TDcond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">AE_pmf</span>, <span class="va">pmfs</span>, <span class="va">actuals</span><span class="op">)</span> <span class="op">/</span> <span class="va">Q</span></span>
<span><span class="va">mis</span><span class="op">$</span><span class="va">TDcond</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">MIS_pmf</span>, <span class="va">pmfs</span>, <span class="va">actuals</span>, MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="va">alpha</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rps</span><span class="op">$</span><span class="va">TDcond</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">RPS_pmf</span>, <span class="va">pmfs</span>, <span class="va">actuals</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="skill-scores">Skill scores<a class="anchor" aria-label="anchor" href="#skill-scores"></a>
</h3>
<p>We report the improvement over the base forecasts using the skill
score values and averaging them across experiments. For instance, the
skill score of Gauss on RPS is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">Skill</mtext><mi>%</mi></msub><mspace width="0.167em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mtext mathvariant="normal">RPS, </mtext><mspace width="0.333em"></mspace></mrow><mi>G</mi><mi>a</mi><mi>u</mi><mi>s</mi><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>100</mn><mo>⋅</mo><mfrac><mrow><mtext mathvariant="normal">RPS</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mtext mathvariant="normal">RPS</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>G</mi><mi>a</mi><mi>u</mi><mi>s</mi><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">RPS</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mtext mathvariant="normal">RPS</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>G</mi><mi>a</mi><mi>u</mi><mi>s</mi><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mn>2</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex"> \text{Skill}_{\%}\,(\text{RPS, }Gauss) = 100 \cdot
\frac{\text{RPS}(base) - \text{RPS}(Gauss)}
{(\text{RPS}(base) + \text{RPS}(Gauss))/2}</annotation></semantics></math></p>
<p>This formula is implemented in the function <code>skill.score</code>,
available in the source code of the vignette but not shown here.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        mase <span class="op">=</span> <span class="va">mase</span>,</span>
<span>        mis  <span class="op">=</span> <span class="va">mis</span>,</span>
<span>        rps <span class="op">=</span> <span class="va">rps</span></span>
<span>      <span class="op">)</span></span>
<span><span class="va">scores_</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ref_met</span>  <span class="op">&lt;-</span> <span class="st">"base"</span></span>
<span><span class="va">methods_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Gauss"</span>, <span class="st">"MixCond"</span>, <span class="st">"TDcond"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For each score and method we compute the skill score with respect to the base forecasts</span></span>
<span><span class="va">skill_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">scores_</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">skill_scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">met</span> <span class="kw">in</span> <span class="va">methods_</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">skill_scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"upper"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">met</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">skill.score</span><span class="op">(</span><span class="va">scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">ref_met</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_u</span><span class="op">]</span>, </span>
<span>                                                       <span class="va">scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">met</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_u</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">skill_scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bottom"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">met</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">skill.score</span><span class="op">(</span><span class="va">scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">ref_met</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="op">(</span><span class="va">n_u</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>, </span>
<span>                                                        <span class="va">scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">met</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="op">(</span><span class="va">n_u</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We report in the tables below the mean values for each skill
score.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_skill_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">scores_</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mean_skill_scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">skill_scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"upper"</span><span class="op">]</span><span class="op">]</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">skill_scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bottom"</span><span class="op">]</span><span class="op">]</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span>                                     <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mean_skill_scores</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"upper"</span>,<span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">mean_skill_scores</span><span class="op">$</span><span class="va">mase</span>,digits <span class="op">=</span> <span class="fl">2</span>,caption <span class="op">=</span> <span class="st">"Mean skill score on MASE."</span>,align <span class="op">=</span> <span class="st">'lccc'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Mean skill score on MASE.</caption>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Gauss</th>
<th align="center">MixCond</th>
<th align="center">TDcond</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">upper</td>
<td align="left">-23.44</td>
<td align="center">-12.61</td>
<td align="center">0.69</td>
</tr>
<tr class="even">
<td align="left">bottom</td>
<td align="left">-89.51</td>
<td align="center">-0.28</td>
<td align="center">0.31</td>
</tr>
</tbody>
</table>
<p>The mean MASE skill score is positive only for the TD-cond
reconciliation. Both Mix-cond and Gauss achieve scores lower than the
base forecasts, even if Mix-cond degrades less the base forecasts
compared to Gauss.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">mean_skill_scores</span><span class="op">$</span><span class="va">mis</span>,digits <span class="op">=</span> <span class="fl">2</span>,caption <span class="op">=</span> <span class="st">"Mean skill score on MIS."</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Mean skill score on MIS.</caption>
<thead><tr class="header">
<th align="left"></th>
<th align="right">Gauss</th>
<th align="right">MixCond</th>
<th align="right">TDcond</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">upper</td>
<td align="right">-66.19</td>
<td align="right">-73.49</td>
<td align="right">1.04</td>
</tr>
<tr class="even">
<td align="left">bottom</td>
<td align="right">-36.88</td>
<td align="right">0.16</td>
<td align="right">1.82</td>
</tr>
</tbody>
</table>
<p>The mean MIS score of TD-cond is slightly above that of the base
forecasts. Mix-cond achieves slightly higher scores than the base
forecasts only on the bottom variables. Gauss strongly degrades the base
forecasts according to this metric.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">mean_skill_scores</span><span class="op">$</span><span class="va">rps</span>,digits <span class="op">=</span> <span class="fl">2</span>,caption <span class="op">=</span> <span class="st">"Mean skill score on RPS."</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Mean skill score on RPS.</caption>
<thead><tr class="header">
<th align="left"></th>
<th align="right">Gauss</th>
<th align="right">MixCond</th>
<th align="right">TDcond</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">upper</td>
<td align="right">-30.69</td>
<td align="right">-24.99</td>
<td align="right">0.08</td>
</tr>
<tr class="even">
<td align="left">bottom</td>
<td align="right">-55.62</td>
<td align="right">2.02</td>
<td align="right">3.95</td>
</tr>
</tbody>
</table>
<p>The mean RPS skill score for TD-cond is positive for both upper and
bottom time series. Mix-cond slightly improves the base forecasts on the
bottom variables, however it degrades the upper base forecasts. Gauss
strongly degrades both upper and bottom base forecasts.</p>
</div>
<div class="section level3">
<h3 id="boxplots">Boxplots<a class="anchor" aria-label="anchor" href="#boxplots"></a>
</h3>
<p>Finally, we show the boxplots of the skill scores for each method
divided in upper and bottom levels.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#a8a8e4"</span>, </span>
<span>                  <span class="st">"#a9c7e4"</span>,</span>
<span>                  <span class="st">"#aae4df"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Boxplots of MASE skill scores</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">skill_scores</span><span class="op">$</span><span class="va">mase</span><span class="op">$</span><span class="va">upper</span>, main <span class="op">=</span> <span class="st">"MASE upper time series"</span>, </span>
<span>        col <span class="op">=</span> <span class="va">custom_colors</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">80</span>,<span class="fl">80</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span>,lty<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">skill_scores</span><span class="op">$</span><span class="va">mase</span><span class="op">$</span><span class="va">bottom</span>, main <span class="op">=</span> <span class="st">"MASE bottom time series"</span>, </span>
<span>        col <span class="op">=</span> <span class="va">custom_colors</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">200</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span>,lty<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="mixed_reconciliation_files/figure-html/MASEboxplots-1.png" alt="**Figure 2**: boxplot of MASE skill scores for upper and bottom time series." width="672"><p class="caption">
<strong>Figure 2</strong>: boxplot of MASE skill scores for upper and
bottom time series.
</p>
</div>
<p>Both Mix-cond and TD-cond do not improve the bottom MASE over the
base forecasts (boxplot flattened on the value zero), however TD-cond
provides a slight improvement over the upper base forecasts (boxplot
over the zero line).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Boxplots of MIS skill scores</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">skill_scores</span><span class="op">$</span><span class="va">mis</span><span class="op">$</span><span class="va">upper</span>, main <span class="op">=</span> <span class="st">"MIS upper time series"</span>, </span>
<span>        col <span class="op">=</span> <span class="va">custom_colors</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">150</span>,<span class="fl">150</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span>,lty<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">skill_scores</span><span class="op">$</span><span class="va">mis</span><span class="op">$</span><span class="va">bottom</span>, main <span class="op">=</span> <span class="st">"MIS bottom time series"</span>, </span>
<span>        col <span class="op">=</span> <span class="va">custom_colors</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">200</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span>,lty<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="mixed_reconciliation_files/figure-html/MISboxplots-1.png" alt="**Figure 3**: boxplot of MIS skill scores for upper and bottom time series." width="672"><p class="caption">
<strong>Figure 3</strong>: boxplot of MIS skill scores for upper and
bottom time series.
</p>
</div>
<p>Both Mix-cond and TD-cond do not improve nor degrade the bottom base
forecasts in MIS score as shown by the small boxplots centered around
zero. On the upper variables instead only TD-cond does not degrade the
MIS score of the base forecasts.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Boxplots of RPS skill scores</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">skill_scores</span><span class="op">$</span><span class="va">rps</span><span class="op">$</span><span class="va">upper</span>, main <span class="op">=</span> <span class="st">"RPS upper time series"</span>, </span>
<span>        col <span class="op">=</span> <span class="va">custom_colors</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">80</span>,<span class="fl">80</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span>,lty<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">skill_scores</span><span class="op">$</span><span class="va">rps</span><span class="op">$</span><span class="va">bottom</span>, main <span class="op">=</span> <span class="st">"RPS bottom time series"</span>, </span>
<span>        col <span class="op">=</span> <span class="va">custom_colors</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">200</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span>,lty<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="mixed_reconciliation_files/figure-html/RPSboxplots-1.png" alt="**Figure 4**: boxplot of RPS skill scores for upper and bottom time series." width="672"><p class="caption">
<strong>Figure 4</strong>: boxplot of RPS skill scores for upper and
bottom time series.
</p>
</div>
<p>According to RPS, TD-cond does not degrade the bottom base forecasts
and improves the upper base forecasts. On the other hand both Gauss and
Mix-cond strongly degrade the upper base forecasts.</p>
</div>
</div>
<div class="section level2">
<h2 id="full-reproducibility">Full reproducibility<a class="anchor" aria-label="anchor" href="#full-reproducibility"></a>
</h2>
<p>The full experiment described in <span class="citation">(Zambon et
al. 2024)</span> can be reproduced by using the code available <a href="https://github.com/LorenzoZambon/M5_MixedReconc" class="external-link">here</a>.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-corani2021probabilistic" class="csl-entry">
Corani, Giorgio, Dario Azzimonti, João P. S. C. Augusto, and Marco
Zaffalon. 2021. <span>“Probabilistic Reconciliation of Hierarchical
Forecast via Bayes’ Rule.”</span> In <em>Machine Learning and Knowledge
Discovery in Databases</em>, edited by Frank Hutter, Kristian Kersting,
Jefrey Lijffijt, and Isabel Valera, 211–26. Springer International
Publishing. <a href="https://doi.org/10.1007/978-3-030-67664-3_13" class="external-link">https://doi.org/10.1007/978-3-030-67664-3_13</a>.
</div>
<div id="ref-MAKRIDAKIS20221325" class="csl-entry">
Makridakis, Spyros, Evangelos Spiliotis, and Vassilios Assimakopoulos.
2022. <span>“<span class="nocase">The M5 competition: Background,
organization, and implementation</span>.”</span> <em>International
Journal of Forecasting</em> 38 (4): 1325–36. <a href="https://doi.org/10.1016/j.ijforecast.2021.07.007" class="external-link">https://doi.org/10.1016/j.ijforecast.2021.07.007</a>.
</div>
<div id="ref-smooth_pkg" class="csl-entry">
Svetunkov, Ivan. 2023. <em>Smooth: Forecasting Using State Space
Models</em>. <a href="https://cran.r-project.org/package=smooth" class="external-link">https://cran.r-project.org/package=smooth</a>.
</div>
<div id="ref-svetunkov2023iets" class="csl-entry">
Svetunkov, Ivan, and John E Boylan. 2023. <span>“<span class="nocase">iETS: State space model for intermittent demand
forecasting</span>.”</span> <em>International Journal of Production
Economics</em> 265: 109013. <a href="https://doi.org/10.1016/j.ijpe.2023.109013" class="external-link">https://doi.org/10.1016/j.ijpe.2023.109013</a>.
</div>
<div id="ref-zambon2024mixed" class="csl-entry">
Zambon, Lorenzo, Dario Azzimonti, Nicolò Rubattu, and Giorgio Corani.
2024. <span>“Probabilistic Reconciliation of Mixed-Type Hierarchical
Time Series.”</span> In <em>Proceedings of the Fortieth Conference on
Uncertainty in Artificial Intelligence</em>, edited by Negar Kiyavash
and Joris M. Mooij, 244:4078–95. Proceedings of Machine Learning
Research. PMLR. <a href="https://proceedings.mlr.press/v244/zambon24a.html" class="external-link">https://proceedings.mlr.press/v244/zambon24a.html</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dario Azzimonti, Nicolò Rubattu, Lorenzo Zambon, Giorgio Corani.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
