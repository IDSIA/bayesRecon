<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Probabilistic Reconciliation via Conditioning with `bayesRecon` • bayesRecon</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Probabilistic Reconciliation via Conditioning with `bayesRecon`">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bayesRecon</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/bayesRecon.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/mixed_reconciliation.html">Reconciliation of M5 hierarchy with mixed-type forecasts</a></li>
    <li><a class="dropdown-item" href="../articles/reconciliation_properties.html">Properties of the reconciled distribution via conditioning</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/IDSIA/bayesRecon/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Probabilistic Reconciliation via Conditioning with `bayesRecon`</h1>
                        <h4 data-toc-skip class="author">Nicolò Rubattu,
Giorgio Corani, Dario Azzimonti, Lorenzo Zambon</h4>
            
            <h4 data-toc-skip class="date">2023-11-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/IDSIA/bayesRecon/blob/main/vignettes/bayesRecon.Rmd" class="external-link"><code>vignettes/bayesRecon.Rmd</code></a></small>
      <div class="d-none name"><code>bayesRecon.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette shows how to perform <em>probabilistic
reconciliation</em> with the <code>bayesRecon</code> package. We provide
three examples:</p>
<ol style="list-style-type: decimal">
<li><p><em>Temporal hierarchy for a count time series</em>: we build a
temporal hierarchy over a count time series, produce the base forecasts
using <code>glarma</code> and reconcile them via Bottom-Up Importance
Sampling (BUIS).</p></li>
<li><p><em>Temporal hierarchy for a smooth time series</em>: we build a
temporal hierarchy over a smooth time series, compute the base forecasts
using <code>ets</code> and we reconcile them in closed form using
Gaussian reconciliation. The covariance matrix is diagonal.</p></li>
<li><p><em>Hierarchical of smooth time series</em>: this is an example
of a cross-sectional hierarchy. We generate the base forecasts using
<code>ets</code> and we reconcile them via Gaussian reconciliation. The
covariance matrix is full and estimated via shrinkage.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>The package, available at this <a href="https://cran.r-project.org/package=bayesRecon" class="external-link">CRAN page</a>, can
be installed and loaded with the usual commands:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'bayesRecon'</span>, dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Load the package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/IDSIA/bayesRecon" class="external-link">bayesRecon</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="temporal-hierarchy-over-a-count-time-series">Temporal hierarchy over a count time series<a class="anchor" aria-label="anchor" href="#temporal-hierarchy-over-a-count-time-series"></a>
</h2>
<p>We select a monthly time series of counts from the <em>carparts</em>
dataset, available from the expsmooth package <span class="citation">(R.
J. Hyndman 2015)</span>. The data set contains time series of sales of
cars part from Jan. 1998 to Mar. 2002. For this example we select time
series #2655, which we make available as
<code><a href="../reference/carparts_example.html">bayesRecon::carparts_example</a></code>.</p>
<p>This time series has a skewed distribution of values.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span>mat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">carparts_example</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Car part sales"</span>, main <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">carparts_example</span>, xlab <span class="op">=</span> <span class="st">"Car part sales"</span>, main <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="bayesRecon_files/figure-html/carpart-plot-1.png" alt="**Figure 1**: Carpart - monthly car part sales." width="100%"><p class="caption">
<strong>Figure 1</strong>: Carpart - monthly car part sales.
</p>
</div>
<p><br><br> We divide the time series into train and test; the test set
contains the last 12 months.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/window.html" class="external-link">window</a></span><span class="op">(</span><span class="va">carparts_example</span>, end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2001</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/window.html" class="external-link">window</a></span><span class="op">(</span><span class="va">carparts_example</span>, start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2001</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- In order to do hierarchical forecasting: -->
<!-- 1.    we build a temporal hierarchy; -->
<!-- 2.    we compute the *base forecasts*) at each temporal scale. -->
<p>We build the temporal hierarchy using the
<code>temporal aggregation</code> function. We specify the aggregation
levels using the <code>agg_levels</code> argument; in this case they are
<em>2-Monthly</em>, <em>Quarterly</em>, <em>4-Monthly</em>,
<em>Biannual</em>, and <em>Annual</em>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train.agg</span> <span class="op">&lt;-</span> <span class="fu">bayesRecon</span><span class="fu">::</span><span class="fu"><a href="../reference/temporal_aggregation.html">temporal_aggregation</a></span><span class="op">(</span><span class="va">train</span>, agg_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Annual"</span>, <span class="st">"Biannual"</span>, <span class="st">"4-Monthly"</span>, <span class="st">"Quarterly"</span>, <span class="st">"2-Monthly"</span>, <span class="st">"Monthly"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">train.agg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">levels</span></span></code></pre></div>
<p>The function returns a list of aggregated time series, ordered from
the most aggregated (top of the hierarchy) to the most disagreggated
(bottom of the hierarchy). We plot them below.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, mai <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.6</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="va">levels</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">train.agg</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Car part sales"</span>, main <span class="op">=</span> <span class="va">l</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="bayesRecon_files/figure-html/temp-agg-plot-1.png" alt="**Figure 2**: The aggregated time series of the temporal hierarchy." width="100%"><p class="caption">
<strong>Figure 2</strong>: The aggregated time series of the temporal
hierarchy.
</p>
</div>
<p><br><br> We compute the <em>base forecasts</em> using the package <a href="https://cran.r-project.org/package=glarma" class="external-link"><code>glarma</code></a>,
a package specific for forecasting count time series. We forecast 12
steps ahead at the monthly level, 4 steps ahead at the quarterly level,
etc. by iterating over the levels of the hierarchy, At each level, we
fit a <code>glarma</code> model with Poisson predictive distribution and
we forecast; each forecast is constituted by 20000 integer samples.</p>
<p>Eventually we collect the samples of the 28 predictive distributions
(one at the <em>Annual</em> level, two at the <em>Biannual</em> level,
etc.) in a list. The code below takes about 30 seconds on a standard
computer.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("glarma", dependencies = TRUE)</span></span>
<span><span class="co">#library(glarma)</span></span>
<span></span>
<span><span class="va">fc.samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fl">20000</span></span>
<span><span class="va">fc.count</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># iterating over the temporal aggregation levels</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">train.agg</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">f.level</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">train.agg</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Forecasting at "</span>, <span class="va">levels</span><span class="op">[</span><span class="va">l</span><span class="op">]</span>, <span class="st">"..."</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># fit an independent model for each aggregation level</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glarma</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/glarma/man/glarma.html" class="external-link">glarma</a></span><span class="op">(</span></span>
<span>    <span class="va">train.agg</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    phiLags <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">f.level</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="fl">1</span> <span class="kw">else</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">6</span>, <span class="va">f.level</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    thetaLags <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">f.level</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="cn">NULL</span> <span class="kw">else</span> <span class="va">f.level</span>,</span>
<span>    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">train.agg</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">train.agg</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"Poi"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># forecast 1 year ahead</span></span>
<span>  <span class="va">h</span> <span class="op">&lt;-</span> <span class="va">f.level</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">h</span>, ncol <span class="op">=</span> <span class="va">D</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">D</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># each call to 'forecast.glarma' returns a simulation path</span></span>
<span>    <span class="va">tmp</span><span class="op">[</span>, <span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">glarma</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/glarma/man/forecast.html" class="external-link">forecast</a></span><span class="op">(</span></span>
<span>      <span class="va">model</span>,</span>
<span>      n.ahead <span class="op">=</span> <span class="va">h</span>,</span>
<span>      newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      newoffset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">h</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">Y</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># collect the forecasted samples</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">h</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fc.samples</span><span class="op">[[</span><span class="va">fc.count</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>    <span class="va">fc.count</span> <span class="op">&lt;-</span> <span class="va">fc.count</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Forecasting at Annual..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at Biannual..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at 4-Monthly..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at Quarterly..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at 2-Monthly..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at Monthly..."</span></span></code></pre></div>
<p>Reconciliation requires the aggregation matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math>,
which we obtain using the function <code>get_reconc_matrices</code>. It
requires:</p>
<ul>
<li>the aggregation factors of the hierarchy, which in this example are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mn>2</mn><mo>,</mo><mn>3</mn><mo>,</mo><mn>4</mn><mo>,</mo><mn>6</mn><mo>,</mo><mn>12</mn><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{2, 3, 4, 6, 12\}</annotation></semantics></math>;</li>
<li>the length of the forecasting horizon at the bottom level, which is
12 in this example.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recon.matrices</span> <span class="op">&lt;-</span> <span class="fu">bayesRecon</span><span class="fu">::</span><span class="fu"><a href="../reference/get_reconc_matrices.html">get_reconc_matrices</a></span><span class="op">(</span>agg_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">12</span><span class="op">)</span>, h <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="co"># Aggregation matrix</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="va">recon.matrices</span><span class="op">$</span><span class="va">A</span> </span></code></pre></div>
<p>To reconcile using Bottom-Up Important Sampling (BUIS) we we use the
function <code>reconc_BUIS</code>, passing to it the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math>
matrix, the <em>base forecasts</em>, the type of the base forecasts
(<code>in_type</code>=“samples”) and whether the samples are continuous
or discrete (<code>distr</code> = “discrete”).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recon.res</span> <span class="op">&lt;-</span> <span class="fu">bayesRecon</span><span class="fu">::</span><span class="fu"><a href="../reference/reconc_BUIS.html">reconc_BUIS</a></span><span class="op">(</span></span>
<span>  <span class="va">A</span>,</span>
<span>  base_forecasts <span class="op">=</span> <span class="va">fc.samples</span>,</span>
<span>  in_type <span class="op">=</span> <span class="st">"samples"</span>,</span>
<span>  distr <span class="op">=</span> <span class="st">"discrete"</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">42</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here we obtain samples from the reconciled forecast distribution.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reconciled_samples</span> <span class="op">&lt;-</span> <span class="va">recon.res</span><span class="op">$</span><span class="va">reconciled_samples</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">reconciled_samples</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]    28 20000</span></span></code></pre></div>
<p>We now compute the Mean Absolute Error (MAE) and the Continuous
Ranked Probability Score (CRPS) for the bottom (i.e., <em>monthly</em>)
time series. For computing CRPS, we use the package <a href="https://cran.r-project.org/package=scoringRules" class="external-link"><code>scoringRules</code></a>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("scoringRules", dependencies = TRUE)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/FK83/scoringRules" class="external-link">scoringRules</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ae.fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ae.reconc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">crps.fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">crps.reconc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">h</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">y.hat_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">fc.samples</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">+</span> <span class="va">h</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">y.reconc_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">recon.res</span><span class="op">$</span><span class="va">bottom_reconciled_samples</span><span class="op">[</span><span class="va">h</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co"># Compute Absolute Errors</span></span>
<span>  <span class="va">ae.fc</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">test</span><span class="op">[</span><span class="va">h</span><span class="op">]</span> <span class="op">-</span> <span class="va">y.hat_</span><span class="op">)</span></span>
<span>  <span class="va">ae.reconc</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">test</span><span class="op">[</span><span class="va">h</span><span class="op">]</span> <span class="op">-</span> <span class="va">y.reconc_</span><span class="op">)</span></span>
<span>  <span class="co"># Compute Continuous Ranked Probability Score (CRPS)</span></span>
<span>  <span class="va">crps.fc</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">scoringRules</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scoringRules/man/scores_sample_univ.html" class="external-link">crps_sample</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">test</span><span class="op">[</span><span class="va">h</span><span class="op">]</span>, dat <span class="op">=</span> <span class="va">fc.samples</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">+</span> <span class="va">h</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">crps.reconc</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">scoringRules</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scoringRules/man/scores_sample_univ.html" class="external-link">crps_sample</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">test</span><span class="op">[</span><span class="va">h</span><span class="op">]</span>, dat <span class="op">=</span> <span class="va">recon.res</span><span class="op">$</span><span class="va">bottom_reconciled_samples</span><span class="op">[</span><span class="va">h</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mae.fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">ae.fc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mae.reconc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">ae.reconc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">crps.fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">crps.fc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">crps.reconc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">crps.reconc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MAE"</span>, <span class="st">"CRPS"</span><span class="op">)</span>,</span>
<span>  base.forecasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mae.fc</span>, <span class="va">crps.fc</span><span class="op">)</span>,</span>
<span>  reconciled.forecasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mae.reconc</span>, <span class="va">crps.reconc</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">metrics</span></span>
<span><span class="co">#&gt;      base.forecasts reconciled.forecasts</span></span>
<span><span class="co">#&gt; MAE       1.2500000            1.0000000</span></span>
<span><span class="co">#&gt; CRPS      0.7093284            0.6509691</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="temporal-hierarchy-over-a-smooth-time-series">Temporal hierarchy over a smooth time series<a class="anchor" aria-label="anchor" href="#temporal-hierarchy-over-a-smooth-time-series"></a>
</h2>
<p>In this second example, we select a smooth monthly time series
(N1485) from the M3 forecasting competition <span class="citation">(Makridakis and Hibon 2000)</span>. The data set is
available in the Mcomp package <span class="citation">(R. Hyndman
2018)</span> and we make available this time series as
<code><a href="../reference/M3_example.html">bayesRecon::M3_example</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">train</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"y"</span>, main <span class="op">=</span> <span class="st">"N1485"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="bayesRecon_files/figure-html/m3-plot-1.png" alt="**Figure 3**: M3 - N1485 time series." width="100%"><p class="caption">
<strong>Figure 3</strong>: M3 - N1485 time series.
</p>
</div>
<p><br> We build the temporal hierarchy using the
<code>temporal_aggregation</code> function.</p>
<p>Without specifying <code>agg_levels</code>, the function generates by
default all the feasible aggregation: 2-Monthly, Quarterly, 4-Monthly,
Biannual, and Annual.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train.agg</span> <span class="op">&lt;-</span> <span class="fu">bayesRecon</span><span class="fu">::</span><span class="fu"><a href="../reference/temporal_aggregation.html">temporal_aggregation</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">train</span><span class="op">)</span></span>
<span><span class="va">levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Annual"</span>, <span class="st">"Biannual"</span>, <span class="st">"4-Monthly"</span>, <span class="st">"Quarterly"</span>, <span class="st">"2-Monthly"</span>, <span class="st">"Monthly"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">train.agg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">levels</span></span></code></pre></div>
<p>We generate the base forecasts using <code>ets</code> from the <a href="https://cran.r-project.org/package=forecast" class="external-link">forecast</a> package
<span class="citation">(R. J. Hyndman and Khandakar 2008)</span>. At
every level we predict 18 months ahead. All the predictive distributions
are Gaussian.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("forecast", dependencies = TRUE)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.robjhyndman.com/forecast/" class="external-link">forecast</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Registered S3 method overwritten by 'quantmod':</span></span>
<span><span class="co">#&gt;   method            from</span></span>
<span><span class="co">#&gt;   as.zoo.data.frame zoo</span></span>
<span></span>
<span><span class="va">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span><span class="va">H</span></span>
<span><span class="co">#&gt; [1] 18</span></span>
<span></span>
<span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">level.idx</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">fc.idx</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">level</span> <span class="kw">in</span> <span class="va">train.agg</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">level.name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">train.agg</span><span class="op">)</span><span class="op">[</span><span class="va">level.idx</span><span class="op">]</span></span>
<span>  <span class="co"># fit an ETS model for each temporal level</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link">ets</a></span><span class="op">(</span><span class="va">level</span><span class="op">)</span></span>
<span>  <span class="co"># generate forecasts for each level within 18 months</span></span>
<span>  <span class="va">h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">H</span> <span class="op">/</span> <span class="op">(</span><span class="fl">12</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">level</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Forecasting at "</span>, <span class="va">level.name</span>, <span class="st">", h="</span>, <span class="va">h</span>, <span class="st">"..."</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">level.fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">model</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span></span>
<span>  <span class="co"># save mean and sd of the gaussian predictive distribution</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">h</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fc</span><span class="op">[[</span><span class="va">fc.idx</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">level.fc</span><span class="op">$</span><span class="va">mean</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                         sd <span class="op">=</span> <span class="op">(</span><span class="va">level.fc</span><span class="op">$</span><span class="va">upper</span><span class="op">[</span>, <span class="st">"95%"</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">level.fc</span><span class="op">$</span><span class="va">mean</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">fc.idx</span> <span class="op">&lt;-</span> <span class="va">fc.idx</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">level.idx</span> <span class="op">&lt;-</span> <span class="va">level.idx</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Forecasting at Annual, h=1..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at Biannual, h=3..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at 4-Monthly, h=4..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at Quarterly, h=6..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at 2-Monthly, h=9..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at Monthly, h=18..."</span></span></code></pre></div>
<p>Using the function <code>get_reconc_matrices</code>, we get matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_reconc_matrices.html">get_reconc_matrices</a></span><span class="op">(</span>agg_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">12</span><span class="op">)</span>, h <span class="op">=</span> <span class="fl">18</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mai <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">rmat</span><span class="op">$</span><span class="va">A</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">rmat</span><span class="op">$</span><span class="va">A</span><span class="op">)</span>, </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">rmat</span><span class="op">$</span><span class="va">A</span><span class="op">)</span>,<span class="fl">1</span>,<span class="va">rev</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      xaxt<span class="op">=</span><span class="st">'n'</span>, yaxt<span class="op">=</span><span class="st">'n'</span>, ylab <span class="op">=</span> <span class="st">""</span>, xlab <span class="op">=</span> <span class="va">levels</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, at<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">rmat</span><span class="op">$</span><span class="va">A</span><span class="op">)</span>, label<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">rmat</span><span class="op">$</span><span class="va">A</span><span class="op">)</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">23</span>,<span class="fl">22</span>,<span class="fl">19</span>,<span class="fl">15</span>,<span class="fl">9</span><span class="op">)</span>, label<span class="op">=</span><span class="va">levels</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, las<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="bayesRecon_files/figure-html/m3-rmat-1.png" alt="**Figure 4**: M3 - The aggregation matrix A (red=1, yellow=0)." width="70%"><p class="caption">
<strong>Figure 4</strong>: M3 - The aggregation matrix A (red=1,
yellow=0).
</p>
</div>
<p><br> The function <code>reconc_gaussian</code> implements the exact
Gaussian reconciliation. We also run <code>reconc_BUIS</code>, to check
the consistency between the two approaches.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recon.gauss</span> <span class="op">&lt;-</span> <span class="fu">bayesRecon</span><span class="fu">::</span><span class="fu"><a href="../reference/reconc_gaussian.html">reconc_gaussian</a></span><span class="op">(</span></span>
<span>  A <span class="op">=</span> <span class="va">rmat</span><span class="op">$</span><span class="va">A</span>,</span>
<span>  base_forecasts.mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fc</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  base_forecasts.Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fc</span>, <span class="st">"[["</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">reconc.buis</span> <span class="op">&lt;-</span> <span class="fu">bayesRecon</span><span class="fu">::</span><span class="fu"><a href="../reference/reconc_BUIS.html">reconc_BUIS</a></span><span class="op">(</span></span>
<span>  A <span class="op">=</span> <span class="va">rmat</span><span class="op">$</span><span class="va">A</span>,</span>
<span>  base_forecasts <span class="op">=</span> <span class="va">fc</span>,</span>
<span>  in_type <span class="op">=</span> <span class="st">"params"</span>,</span>
<span>  distr <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  num_samples <span class="op">=</span> <span class="fl">20000</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">42</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check that the algorithms return consistent results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rmat</span><span class="op">$</span><span class="va">S</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">recon.gauss</span><span class="op">$</span><span class="va">bottom_reconciled_mean</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">reconc.buis</span><span class="op">$</span><span class="va">reconciled_samples</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10] [,11] [,12]</span></span>
<span><span class="co">#&gt; [1,] 74977 35913 39063 41491 23520 25136 26321 27174 17464 18450 19251 19812</span></span>
<span><span class="co">#&gt; [2,] 74946 35897 39049 41470 23532 25091 26323 27134 17462 18435 19231 19818</span></span>
<span><span class="co">#&gt;      [,13] [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24]</span></span>
<span><span class="co">#&gt; [1,] 20412 21079 11527 11993 12393 12743 13047 13274 13531 13643 14317  5694</span></span>
<span><span class="co">#&gt; [2,] 20425 21046 11547 11985 12365 12726 13041 13282 13482 13652 14336  5694</span></span>
<span><span class="co">#&gt;      [,25] [,26] [,27] [,28] [,29] [,30] [,31] [,32] [,33] [,34] [,35] [,36]</span></span>
<span><span class="co">#&gt; [1,]  5833  5936  6056  6138  6255  6324  6419  6508  6538  6619  6655  6759</span></span>
<span><span class="co">#&gt; [2,]  5853  5914  6070  6127  6237  6308  6418  6505  6536  6612  6670  6729</span></span>
<span><span class="co">#&gt;      [,37] [,38] [,39] [,40] [,41]</span></span>
<span><span class="co">#&gt; [1,]  6772  6881  6762  7160  7157</span></span>
<span><span class="co">#&gt; [2,]  6753  6943  6709  7152  7184</span></span></code></pre></div>
<p>We now compare <em>base forecasts</em> and <em>reconciled
forecasts</em>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yhat.mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fc</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">18</span><span class="op">)</span></span>
<span><span class="va">yhat.sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fc</span>, <span class="st">"[["</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">18</span><span class="op">)</span></span>
<span><span class="va">yhat.hi95</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span>, mean <span class="op">=</span> <span class="va">yhat.mu</span>, sd <span class="op">=</span> <span class="va">yhat.sigma</span><span class="op">)</span></span>
<span><span class="va">yhat.lo95</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.025</span>, mean <span class="op">=</span> <span class="va">yhat.mu</span>, sd <span class="op">=</span> <span class="va">yhat.sigma</span><span class="op">)</span></span>
<span><span class="va">yreconc.mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">reconc.buis</span><span class="op">$</span><span class="va">bottom_reconciled_samples</span><span class="op">)</span></span>
<span><span class="va">yreconc.hi95</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">reconc.buis</span><span class="op">$</span><span class="va">bottom_reconciled_samples</span>, <span class="fl">1</span>, </span>
<span>                      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">yreconc.lo95</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">reconc.buis</span><span class="op">$</span><span class="va">bottom_reconciled_samples</span>, <span class="fl">1</span>, </span>
<span>                      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.025</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ylim_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">train</span>, <span class="va">M3_example</span><span class="op">$</span><span class="va">test</span>, <span class="va">yhat.lo95</span>, <span class="va">yreconc.lo95</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">train</span>, <span class="va">M3_example</span><span class="op">$</span><span class="va">test</span>, <span class="va">yhat.hi95</span>, <span class="va">yreconc.hi95</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">train</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1990</span>, <span class="fl">1995.6</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="va">ylim_</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"y"</span>, main <span class="op">=</span> <span class="st">"N1485 Forecasts"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">test</span>, lty <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">yhat.mu</span>, start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/start.html" class="external-link">start</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">test</span><span class="op">)</span>, frequency <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, </span>
<span>      col <span class="op">=</span> <span class="st">"coral"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">yreconc.mu</span>, start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/start.html" class="external-link">start</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">test</span><span class="op">)</span>, frequency <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, </span>
<span>      col <span class="op">=</span> <span class="st">"blue2"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">M3_example</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">xtest</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">xtest</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yhat.mu</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">yhat.hi95</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"#FF7F5066"</span>, border <span class="op">=</span> <span class="st">"#FF7F5066"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">xtest</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">xtest</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yhat.mu</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">yhat.lo95</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"#FF7F5066"</span>, border <span class="op">=</span> <span class="st">"#FF7F5066"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">xtest</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">xtest</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yreconc.mu</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">yreconc.hi95</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"#0000EE4D"</span>, border <span class="op">=</span> <span class="st">"#0000EE4D"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">xtest</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">xtest</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yreconc.mu</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">yreconc.lo95</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"#0000EE4D"</span>, border <span class="op">=</span> <span class="st">"#0000EE4D"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="bayesRecon_files/figure-html/m3-plotfore-1.png" alt="**Figure 5**: M3 - Base and reconciled forecasts. The black line shows the actual data (dashed in the test). The orange line is the  mean of the base forecasts, the blu line is the reconciled mean. We also show the 95% prediction intervals." width="100%"><p class="caption">
<strong>Figure 5</strong>: M3 - Base and reconciled forecasts. The black
line shows the actual data (dashed in the test). The orange line is the
mean of the base forecasts, the blu line is the reconciled mean. We also
show the 95% prediction intervals.
</p>
</div>
</div>
<div class="section level2">
<h2 id="gaussian-reconciliation-of-a-cross-sectional-hierarchy">Gaussian reconciliation of a cross-sectional hierarchy<a class="anchor" aria-label="anchor" href="#gaussian-reconciliation-of-a-cross-sectional-hierarchy"></a>
</h2>
<p>In this example, we consider the hierarchical time series
<em>infantgts</em>, which is available from the <code>hts</code> package
<span class="citation">(R. Hyndman et al. 2021)</span> We make it
available also in our package as
<code><a href="../reference/infantMortality.html">bayesRecon::infantMortality</a></code>.</p>
<p>It contains counts of infant mortality (deaths) in Australia,
disaggregated by state and sex (male and female).</p>
<!-- State codes refer to: New South Wales (NSW), Victoria (VIC), Queensland (QLD), South Australia (SA), Western Australia (WA), Northern Territory (NT), Australian Capital Territory (ACT), and Tasmania (TAS). -->
<p>We forecast one year ahead using <code>auto.arima</code> from the <a href="https://cran.r-project.org/package=forecast" class="external-link"><code>forecast</code></a>
package. We collect the residuals, which we will later use to compute
the covariance matrix.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("forecast", dependencies = TRUE)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.robjhyndman.com/forecast/" class="external-link">forecast</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,</span>
<span>                    nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">infantMortality</span><span class="op">$</span><span class="va">total</span><span class="op">)</span>,</span>
<span>                    ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">infantMortality</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fc.idx</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">infantMortality</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s.name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">infantMortality</span><span class="op">)</span><span class="op">[</span><span class="va">fc.idx</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Forecasting at "</span>, <span class="va">s.name</span>, <span class="st">"..."</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># fit an auto.arima model and forecast with h=1</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/auto.arima.html" class="external-link">auto.arima</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span>  <span class="va">s.fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">model</span>, h <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="co"># save mean and sd of the gaussian predictive distribution</span></span>
<span>  <span class="va">fc</span><span class="op">[[</span><span class="va">s.name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s.fc</span><span class="op">$</span><span class="va">mean</span>,</span>
<span>                    <span class="op">(</span><span class="va">s.fc</span><span class="op">$</span><span class="va">upper</span><span class="op">[</span>, <span class="st">"95%"</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">s.fc</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">residuals</span><span class="op">[</span>, <span class="va">fc.idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">s.fc</span><span class="op">$</span><span class="va">residuals</span></span>
<span>  <span class="va">fc.idx</span> <span class="op">&lt;-</span> <span class="va">fc.idx</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Forecasting at total..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at NSW..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at VIC..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at QLD..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at SA..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at WA..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at NT..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at ACT..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at TAS..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at male..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at female..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at NSW male..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at NSW female..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at VIC male..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at VIC female..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at QLD male..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at QLD female..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at SA male..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at SA female..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at WA male..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at WA female..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at NT male..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at NT female..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at ACT male..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at ACT female..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at TAS male..."</span></span>
<span><span class="co">#&gt; [1] "Forecasting at TAS female..."</span></span></code></pre></div>
<p>Now we build the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math>
matrix.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># we have 16 bottom time series, and 11 upper time series</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,</span>
<span>                     <span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,</span>
<span>                     <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,</span>
<span>                     <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,</span>
<span>                     <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,</span>
<span>                     <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,</span>
<span>                     <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,</span>
<span>                     <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,</span>
<span>                     <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,</span>
<span>                     <span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,</span>
<span>                     <span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, byrow<span class="op">=</span><span class="cn">TRUE</span>, ncol <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot of A</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mai <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>,<span class="fl">1</span>,<span class="va">rev</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      xaxt<span class="op">=</span><span class="st">'n'</span>, yaxt<span class="op">=</span><span class="st">'n'</span>, ann<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, at<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">infantMortality</span><span class="op">)</span><span class="op">[</span><span class="fl">12</span><span class="op">:</span><span class="fl">27</span><span class="op">]</span>, las<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">11</span><span class="op">)</span>, label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">infantMortality</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">11</span><span class="op">]</span><span class="op">)</span>, las<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="bayesRecon_files/figure-html/infants-s-1.png" alt="**Figure 6**: Infants mortality - The aggregation matrix A (red=1, yellow=0)." width="70%"><p class="caption">
<strong>Figure 6</strong>: Infants mortality - The aggregation matrix A
(red=1, yellow=0).
</p>
</div>
<p><br> We use <code><a href="../reference/schaferStrimmer_cov.html">bayesRecon::schaferStrimmer_cov</a></code> to estimate
the covariance matrix of the residuals with shrinkage <span class="citation">(Schäfer and Strimmer 2005)</span>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># means</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fc</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># Shrinkage covariance</span></span>
<span><span class="va">shrink.res</span> <span class="op">&lt;-</span> <span class="fu">bayesRecon</span><span class="fu">::</span><span class="fu"><a href="../reference/schaferStrimmer_cov.html">schaferStrimmer_cov</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"The estimated shrinkage intensity is"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">shrink.res</span><span class="op">$</span><span class="va">lambda_star</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "The estimated shrinkage intensity is 0.153"</span></span>
<span><span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="va">shrink.res</span><span class="op">$</span><span class="va">shrink_cov</span></span></code></pre></div>
<p>We now perform Gaussian reconciliation:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recon.gauss</span> <span class="op">&lt;-</span> <span class="fu">bayesRecon</span><span class="fu">::</span><span class="fu"><a href="../reference/reconc_gaussian.html">reconc_gaussian</a></span><span class="op">(</span><span class="va">A</span>,</span>
<span>                                           base_forecasts.mu <span class="op">=</span> <span class="va">mu</span>,</span>
<span>                                           base_forecasts.Sigma <span class="op">=</span> <span class="va">Sigma</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bottom_mu_reconc</span> <span class="op">&lt;-</span> <span class="va">recon.gauss</span><span class="op">$</span><span class="va">bottom_reconciled_mean</span></span>
<span><span class="va">bottom_Sigma_reconc</span> <span class="op">&lt;-</span> <span class="va">recon.gauss</span><span class="op">$</span><span class="va">bottom_reconciled_covariance</span></span>
<span></span>
<span><span class="co"># Obtain reconciled mu and Sigma for the upper variable</span></span>
<span><span class="va">upper_mu_reconc</span> <span class="op">&lt;-</span> <span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">bottom_mu_reconc</span></span>
<span><span class="va">upper_Sigma_reconc</span> <span class="op">&lt;-</span> <span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">bottom_Sigma_reconc</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span></span>
<span><span class="va">upper_mu_reconc</span></span>
<span><span class="co">#&gt;            [,1]</span></span>
<span><span class="co">#&gt;  [1,] 688.82408</span></span>
<span><span class="co">#&gt;  [2,] 190.05371</span></span>
<span><span class="co">#&gt;  [3,] 165.26902</span></span>
<span><span class="co">#&gt;  [4,] 173.39776</span></span>
<span><span class="co">#&gt;  [5,]  40.95861</span></span>
<span><span class="co">#&gt;  [6,]  63.82008</span></span>
<span><span class="co">#&gt;  [7,]  20.37299</span></span>
<span><span class="co">#&gt;  [8,]  17.24244</span></span>
<span><span class="co">#&gt;  [9,]  17.70948</span></span>
<span><span class="co">#&gt; [10,] 424.30287</span></span>
<span><span class="co">#&gt; [11,] 264.52121</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-corani2021probabilistic" class="csl-entry">
Corani, Giorgio, Dario Azzimonti, João P. S. C. Augusto, and Marco
Zaffalon. 2021. <span>“Probabilistic Reconciliation of Hierarchical
Forecast via Bayes’ Rule.”</span> In <em>Machine Learning and Knowledge
Discovery in Databases</em>, edited by Frank Hutter, Kristian Kersting,
Jefrey Lijffijt, and Isabel Valera, 211–26. Springer International
Publishing. <a href="https://doi.org/10.1007/978-3-030-67664-3_13" class="external-link">https://doi.org/10.1007/978-3-030-67664-3_13</a>.
</div>
<div id="ref-corani2023probabilistic" class="csl-entry">
Corani, Giorgio, Dario Azzimonti, and Nicolò Rubattu. 2024.
<span>“Probabilistic Reconciliation of Count Time Series.”</span>
<em>International Journal of Forecasting</em> 40 (2): 457–69.
https://doi.org/<a href="https://doi.org/10.1016/j.ijforecast.2023.04.003" class="external-link">https://doi.org/10.1016/j.ijforecast.2023.04.003</a>.
</div>
<div id="ref-mcomp_pkg" class="csl-entry">
Hyndman, Rob. 2018. <em>Mcomp: Data from the m-Competitions</em>. <a href="https://CRAN.R-project.org/package=Mcomp" class="external-link">https://CRAN.R-project.org/package=Mcomp</a>.
</div>
<div id="ref-expsmooth_pkg" class="csl-entry">
Hyndman, Rob J. 2015. <em>Expsmooth: Data Sets from "Forecasting with
Exponential Smoothing"</em>. <a href="https://CRAN.R-project.org/package=expsmooth" class="external-link">https://CRAN.R-project.org/package=expsmooth</a>.
</div>
<div id="ref-pkg_forecast" class="csl-entry">
Hyndman, Rob J, and Yeasmin Khandakar. 2008. <span>“Automatic Time
Series Forecasting: The Forecast Package for <span>R</span>.”</span>
<em>Journal of Statistical Software</em> 26 (3): 1–22. <a href="https://doi.org/10.18637/jss.v027.i03" class="external-link">https://doi.org/10.18637/jss.v027.i03</a>.
</div>
<div id="ref-hts_pkg" class="csl-entry">
Hyndman, Rob, Alan Lee, Earo Wang, and Shanika Wickramasuriya. 2021.
<em>Hts: Hierarchical and Grouped Time Series</em>. <a href="https://CRAN.R-project.org/package=hts" class="external-link">https://CRAN.R-project.org/package=hts</a>.
</div>
<div id="ref-makridakis2000m3" class="csl-entry">
Makridakis, Spyros, and Michele Hibon. 2000. <span>“The M3-Competition:
Results, Conclusions and Implications.”</span> <em>International Journal
of Forecasting</em> 16 (4): 451–76.
</div>
<div id="ref-schafer2005shrinkage" class="csl-entry">
Schäfer, Juliane, and Korbinian Strimmer. 2005. <span>“A Shrinkage
Approach to Large-Scale Covariance Matrix Estimation and Implications
for Functional Genomics.”</span> <em>Statistical Applications in
Genetics and Molecular Biology</em> 4 (1).
</div>
<div id="ref-zambon2022efficient" class="csl-entry">
Zambon, Lorenzo, Dario Azzimonti, and Giorgio Corani. 2024.
<span>“Efficient Probabilistic Reconciliation of Forecasts for
Real-Valued and Count Time Series.”</span> <em>Statistics and
Computing</em> 34 (1): 21. <a href="https://doi.org/10.1007/s11222-023-10343-y" class="external-link">https://doi.org/10.1007/s11222-023-10343-y</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dario Azzimonti, Nicolò Rubattu, Lorenzo Zambon, Giorgio Corani.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
